<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ºåŒ—å¸‚ 1999 æ´¾å·¥è³‡æ–™äº’å‹•å„€è¡¨æ¿</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ“Š</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f8fafc;
        }
        .chart-container {
            position: relative;
            height: 320px;
            width: 100%;
        }
        .loading-overlay {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
        .checkbox-card {
            @apply flex items-center gap-2 p-2 rounded-lg border border-slate-100 hover:bg-slate-50 transition-all cursor-pointer select-none;
        }
        .checkbox-card input[type="checkbox"] {
            @apply w-4 h-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500;
        }
        .checkbox-card.active {
            @apply bg-blue-50 border-blue-200 text-blue-700;
        }
        .tab-active {
            border-bottom: 2px solid #3b82f6;
            color: #3b82f6;
        }
        .map-wrapper {
            position: relative;
            padding-bottom: 75%; /* 4:3 Aspect Ratio */
            height: 0;
            overflow: hidden;
            border-radius: 12px;
            background-color: #e2e8f0;
        }
        .map-wrapper iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
        }
        .data-row {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .data-row:hover {
            background-color: #eff6ff !important;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div id="app" class="max-w-7xl mx-auto">
        <!-- æ¨™é¡Œå€åŸŸ -->
        <header class="mb-8 flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div>
                <div class="flex items-center gap-3">
                    <h1 class="text-3xl font-bold text-slate-800 flex items-center gap-2">
                        <i data-lucide="map" class="text-blue-600"></i>
                        è‡ºåŒ—å¸‚ 1999 æ´¾å·¥å„€è¡¨æ¿
                    </h1>
                    <span id="data-status" class="px-3 py-1 rounded-full text-xs font-bold bg-slate-200 text-slate-600 transition-all">
                        æ­£åœ¨é€£ç·šæ•¸æ“šä¸­å¿ƒ...
                    </span>
                </div>
                <p class="text-slate-500 mt-1 italic">å³æ™‚æ•¸æ“šé€£å‹•åˆ†æ (è³‡æ–™é›†ç¸½æ•¸ï¼š<span id="db-total-count">è¼‰å…¥ä¸­...</span> ç­†)</p>
            </div>
            <button onclick="resetFilters()" class="flex items-center justify-center gap-2 bg-white border border-slate-200 text-slate-600 px-6 py-2.5 rounded-xl hover:bg-slate-50 transition-all shadow-sm active:scale-95">
                <i data-lucide="rotate-ccw" size="18"></i> é‡è¨­æ‰€æœ‰æ¢ä»¶
            </button>
        </header>

        <!-- çµ±è¨ˆå¡ç‰‡ -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <div class="flex items-center justify-between mb-4">
                    <div class="p-2 bg-blue-50 rounded-lg text-blue-600"><i data-lucide="layers"></i></div>
                    <span class="text-slate-400 text-[10px] font-bold uppercase tracking-widest">Filter Stats</span>
                </div>
                <div class="text-slate-500 text-sm font-medium">ç¯©é¸çµæœ / æ¨£æœ¬æ± ç­†æ•¸</div>
                <div id="total-count" class="text-4xl font-black text-slate-800 mt-1">--</div>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <div class="flex items-center justify-between mb-4">
                    <div class="p-2 bg-orange-50 rounded-lg text-orange-600"><i data-lucide="activity"></i></div>
                    <span class="text-slate-400 text-[10px] font-bold uppercase tracking-widest">Hot Spot</span>
                </div>
                <div class="text-slate-500 text-sm font-medium">ç›®å‰ç†±é»å€åŸŸ</div>
                <div id="top-district" class="text-3xl font-black text-slate-800 mt-1">--</div>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <div class="flex items-center justify-between mb-4">
                    <div class="p-2 bg-indigo-50 rounded-lg text-indigo-600"><i data-lucide="bar-chart"></i></div>
                    <span class="text-slate-400 text-[10px] font-bold uppercase tracking-widest">Top Issue</span>
                </div>
                <div class="text-slate-500 text-sm font-medium">ä¸»è¦æ´¾å·¥é¡åˆ¥</div>
                <div id="top-category" class="text-3xl font-black text-slate-800 mt-1">--</div>
            </div>
        </div>

        <!-- äº’å‹•è¦–åœ–å€ -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 mb-8">
            <!-- åµŒå…¥åœ°åœ–è¦–åœ– -->
            <div class="lg:col-span-6 bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="font-bold text-slate-800 flex items-center gap-2">
                        <i data-lucide="map-pinned" size="18" class="text-blue-500"></i> åœ°ç†ç©ºé–“è¦–åœ–
                    </h3>
                    <button onclick="restoreOverviewMap()" class="text-xs text-blue-600 hover:underline">è¿”å›ç¸½è¦½åœ°åœ–</button>
                </div>
                <div class="map-wrapper">
                    <iframe id="main-map" src="https://www.google.com/maps/d/u/1/embed?mid=15tn9_31mJBXqrsMOPV-9I7H-PMKa6zs&ehbc=2E312F&noprof=1"></iframe>
                </div>
                <p class="text-[10px] text-slate-400 mt-3 italic text-center">æç¤ºï¼šé»é¸ä¸‹æ–¹æ¡ˆä»¶ï¼Œåœ°åœ–å°‡è‡ªå‹•æ¸…æ´—åœ°å€è³‡è¨Šå¾Œè·³è½‰</p>
            </div>

            <!-- è¡Œæ”¿å€é•·æ¢åœ– -->
            <div class="lg:col-span-6 bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <h3 class="font-bold text-slate-800 flex items-center gap-2 mb-6">
                    <i data-lucide="bar-chart-3" size="18" class="text-orange-500"></i> è¡Œæ”¿å€åˆ†ä½ˆçµ±è¨ˆ (ä»£ç¢¼æ’åº)
                </h3>
                <div class="chart-container h-[450px]">
                    <canvas id="districtChart"></canvas>
                </div>
            </div>
        </div>

        <!-- æ¯”ä¾‹åˆ†æå€ -->
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 mb-8">
            <div class="flex items-center justify-between mb-6">
                <h3 class="font-bold text-slate-800 flex items-center gap-2">
                    <i data-lucide="pie-chart" size="18" class="text-indigo-500"></i> æ¡ˆä»¶é¡å‹ä½”æ¯”åˆ†æ
                </h3>
                <div class="flex gap-4 text-xs font-bold text-slate-400 border-b border-slate-100">
                    <button onclick="switchPieTab('items')" id="tab-items" class="pb-2 transition-all tab-active">å‰åå¤§æ´¾å·¥é …ç›®</button>
                    <button onclick="switchPieTab('groups')" id="tab-groups" class="pb-2 transition-all">ä¸ƒå¤§æ ¸å¿ƒé¡åˆ¥</button>
                </div>
            </div>
            <div class="chart-container h-[350px]" id="container-items">
                <canvas id="categoryChart"></canvas>
            </div>
            <div class="chart-container hidden h-[350px]" id="container-groups">
                <canvas id="groupPieChart"></canvas>
            </div>
        </div>

        <!-- è¤‡é¸æª¢ç´¢å€åŸŸ -->
        <div class="bg-white rounded-3xl shadow-xl border border-slate-200 overflow-hidden mb-12">
            <div class="p-6 md:p-8 border-b border-slate-100 bg-slate-50/50">
                <div class="flex flex-col gap-8">
                    <div>
                        <h3 class="text-xl font-bold text-slate-800">æ•¸æ“šæª¢ç´¢èˆ‡éæ¿¾</h3>
                        <p class="text-slate-500 text-sm mt-1" id="search-hint">è¨­å®šç¯©é¸æ¢ä»¶å¾Œï¼Œé»æ“Šã€ŒåŸ·è¡Œæœå°‹ã€é–‹å§‹åˆ†ææ¨£æœ¬</p>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="space-y-3">
                            <div class="flex items-center justify-between">
                                <label class="text-sm font-bold text-slate-600 flex items-center gap-2">
                                    <i data-lucide="map" size="16"></i> è¡Œæ”¿å€é¸å– (ä¾ä»£ç¢¼æ’åº)
                                </label>
                                <button onclick="toggleAllCheckboxes('dist')" class="text-xs text-blue-600 hover:underline">å…¨é¸/åé¸</button>
                            </div>
                            <div class="grid grid-cols-3 md:grid-cols-4 gap-2" id="district-checks"></div>
                        </div>

                        <div class="space-y-3">
                            <div class="flex items-center justify-between">
                                <label class="text-sm font-bold text-slate-600 flex items-center gap-2">
                                    <i data-lucide="tag" size="16"></i> æ´¾å·¥é¡åˆ¥é¸å– (å¯è¤‡é¸)
                                </label>
                                <button onclick="toggleAllCheckboxes('cat')" class="text-xs text-blue-600 hover:underline">å…¨é¸/åé¸</button>
                            </div>
                            <div class="grid grid-cols-2 gap-2" id="category-checks"></div>
                        </div>
                    </div>

                    <div class="space-y-6 pt-4 border-t border-slate-100">
                        <div class="relative max-w-2xl mx-auto">
                            <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" size="20"></i>
                            <input type="text" id="searchInput" onkeypress="if(event.key==='Enter') searchData()" placeholder="æœå°‹ç·¨è™Ÿã€åœ°å€ã€æ´¾å·¥å…§å®¹..." 
                                class="w-full pl-12 pr-4 py-4 bg-white border border-slate-200 rounded-2xl outline-none focus:ring-2 focus:ring-blue-500 shadow-sm text-lg transition-all">
                        </div>
                        <div class="flex justify-center">
                            <button id="searchBtn" onclick="searchData()" class="w-full md:w-1/2 flex items-center justify-center gap-3 bg-blue-600 hover:bg-blue-700 text-white px-10 py-4 rounded-2xl font-bold text-lg transition-all shadow-lg shadow-blue-100 active:scale-[0.98]">
                                <i data-lucide="filter" size="22"></i> åŸ·è¡Œæœå°‹
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-slate-100/50 text-slate-500 text-[11px] font-bold uppercase tracking-widest">
                            <th class="px-8 py-5">æ¡ˆä»¶ç·¨è™Ÿ</th>
                            <th class="px-8 py-5">æ´¾å·¥é …ç›®</th>
                            <th class="px-8 py-5">æ¡ˆä»¶åœ°å€</th>
                            <th class="px-8 py-5">ç«‹æ¡ˆæ™‚é–“</th>
                        </tr>
                    </thead>
                    <tbody id="data-table-body" class="divide-y divide-slate-50 text-slate-700"></tbody>
                </table>
            </div>

            <div id="load-more-container" class="hidden p-8 text-center bg-slate-50/30 border-t border-slate-100">
                <button id="loadMoreBtn" onclick="loadMore()" class="inline-flex items-center gap-2 px-8 py-3 bg-white border border-slate-200 text-slate-600 font-bold rounded-2xl hover:bg-slate-50 hover:border-slate-300 transition-all shadow-sm">
                    <i data-lucide="plus-circle" size="18"></i> å¾è³‡æ–™åº«è¼‰å…¥æ›´å¤š
                </button>
                <div id="load-more-spinner" class="hidden justify-center items-center py-2">
                    <div class="w-8 h-8 border-3 border-blue-100 border-t-blue-600 rounded-full animate-spin"></div>
                </div>
            </div>

            <div id="table-placeholder" class="p-24 text-center">
                <div class="bg-blue-50 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6">
                    <i data-lucide="search" class="text-blue-400" size="40"></i>
                </div>
                <h4 class="text-slate-800 font-bold text-lg">ç­‰å¾…æª¢ç´¢æŒ‡ä»¤</h4>
                <p class="text-slate-400 mt-2 max-w-xs mx-auto">è«‹å…ˆè¨­å®šä¸Šæ–¹ç¯©é¸æ¢ä»¶å¾Œï¼Œé»æ“Šã€ŒåŸ·è¡Œæœå°‹ã€ã€‚</p>
            </div>
            <div id="loading-table" class="hidden p-24 text-center">
                <div class="w-12 h-12 border-4 border-blue-100 border-t-blue-600 rounded-full animate-spin mx-auto mb-4"></div>
                <p class="text-slate-500 font-medium">æ­£åœ¨ç‚ºæ‚¨é€²è¡Œäº¤å‰éæ¿¾...</p>
            </div>
        </div>

        <div id="loading" class="fixed inset-0 loading-overlay flex flex-col items-center justify-center z-50">
            <div class="w-14 h-14 border-4 border-slate-100 border-t-blue-600 rounded-full animate-spin"></div>
            <p class="text-slate-800 font-bold mt-6 tracking-widest animate-pulse text-center">æ­£åœ¨åŒæ­¥å¸‚åºœå¤§æ•¸æ“šé€šé“...</p>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://data.taipei/api/v1/dataset/95e364a7-4fc6-4f02-b248-876a7a76333a?scope=resourceAquire';
        const OVERVIEW_MAP_URL = "https://www.google.com/maps/d/u/1/embed?mid=15tn9_31mJBXqrsMOPV-9I7H-PMKa6zs&ehbc=2E312F&noprof=1";
        
        // æ¨£æœ¬æ•¸æ“šå‚™æ´
        const fallbackSampleData = [
            {"æ¡ˆä»¶ç·¨è™Ÿ": "2025113010478", "æ´¾å·¥é …ç›®": "å ´æ‰€èˆ‡è¨­æ–½å™ªéŸ³èˆ‰ç™¼", "æ¡ˆä»¶åœ°å€": "å£«æ—å€è‡ºåŒ—å¸‚å£«æ—å€ç¾©ä¿¡é‡Œ009é„°å¤§å—è·¯ï¼‘ï¼‘ï¼è™Ÿ1æ¨“", "ç«‹æ¡ˆæ—¥æœŸ": "20251130", "ç«‹æ¡ˆæ™‚é–“": "235907"},
            {"æ¡ˆä»¶ç·¨è™Ÿ": "2025113010477", "æ´¾å·¥é …ç›®": "å¤§å‹å»¢æ£„ç‰©æ¸…é‹è¯ç¹«", "æ¡ˆä»¶åœ°å€": "ä¿¡ç¾©å€110å°ç£è‡ºåŒ—å¸‚ä¿¡ç¾©å€ä¿¡ç¾©è·¯å…­æ®µ12å··25è™Ÿ", "ç«‹æ¡ˆæ—¥æœŸ": "20251130", "ç«‹æ¡ˆæ™‚é–“": "235430"},
            {"æ¡ˆä»¶ç·¨è™Ÿ": "2025113010476", "æ´¾å·¥é …ç›®": "è·¯ç‡ˆä¸äº®æˆ–æå£", "æ¡ˆä»¶åœ°å€": "ä¸­å±±å€10491å°ç£è‡ºåŒ—å¸‚ä¸­å±±å€åŸºæ¹–è·¯145è™Ÿå¤§ç›´é‡‘ç¢§å¤§å»ˆ", "ç«‹æ¡ˆæ—¥æœŸ": "20251130", "ç«‹æ¡ˆæ™‚é–“": "234050"},
            {"æ¡ˆä»¶ç·¨è™Ÿ": "2025113010474", "æ´¾å·¥é …ç›®": "å ´æ‰€èˆ‡è¨­æ–½å™ªéŸ³èˆ‰ç™¼", "æ¡ˆä»¶åœ°å€": "ä¸­å±±å€è‡ºåŒ—å¸‚ä¸­å±±å€å¤§ç›´é‡Œ027é„°åŒ—å®‰è·¯ï¼•ï¼—ï¼‘è™Ÿ", "ç«‹æ¡ˆæ—¥æœŸ": "20251130", "ç«‹æ¡ˆæ™‚é–“": "233418"},
            {"æ¡ˆä»¶ç·¨è™Ÿ": "2025113010473", "æ´¾å·¥é …ç›®": "å ´æ‰€èˆ‡è¨­æ–½å™ªéŸ³èˆ‰ç™¼", "æ¡ˆä»¶åœ°å€": "å¤§åŒå€è‡ºåŒ—å¸‚å¤§åŒå€æ™¯æ˜Ÿé‡Œ004é„°ç’°æ²³åŒ—è·¯äºŒæ®µï¼˜ï¼“è™Ÿ", "ç«‹æ¡ˆæ—¥æœŸ": "20251130", "ç«‹æ¡ˆæ™‚é–“": "233116"},
            {"æ¡ˆä»¶ç·¨è™Ÿ": "2025113010472", "æ´¾å·¥é …ç›®": "å ´æ‰€èˆ‡è¨­æ–½å™ªéŸ³èˆ‰ç™¼", "æ¡ˆä»¶åœ°å€": "è¬è¯å€è‡ºåŒ—å¸‚è¬è¯å€èœåœ’é‡Œ012é„°åº·å®šè·¯ï¼˜ï¼’è™ŸäºŒæ¨“", "ç«‹æ¡ˆæ—¥æœŸ": "20251130", "ç«‹æ¡ˆæ™‚é–“": "232628"},
            {"æ¡ˆä»¶ç·¨è™Ÿ": "2025113010470", "æ´¾å·¥é …ç›®": "å¤§å‹å»¢æ£„ç‰©æ¸…é‹è¯ç¹«", "æ¡ˆä»¶åœ°å€": "ä¿¡ç¾©å€è‡ºåŒ—å¸‚ä¿¡ç¾©å€æ¾éš†é‡Œ009é„°æ¾å±±è·¯ï¼–ï¼•ï¼å··ï¼‘ï¼•å¼„ï¼’ï¼’è™Ÿå››æ¨“", "ç«‹æ¡ˆæ—¥æœŸ": "20251130", "ç«‹æ¡ˆæ™‚é–“": "232319"},
            {"æ¡ˆä»¶ç·¨è™Ÿ": "2025113010469", "æ´¾å·¥é …ç›®": "è·¯ç‡ˆä¸äº®æˆ–æå£", "æ¡ˆä»¶åœ°å€": "æ¾å±±å€å…«å¾·è·¯ä¸‰æ®µ12å··4å¼„-å…«å¾·è·¯ä¸‰æ®µ8å··", "ç«‹æ¡ˆæ—¥æœŸ": "20251130", "ç«‹æ¡ˆæ™‚é–“": "232308"},
            {"æ¡ˆä»¶ç·¨è™Ÿ": "2025113010468", "æ´¾å·¥é …ç›®": "å¤§å‹å»¢æ£„ç‰©æ¸…é‹è¯ç¹«", "æ¡ˆä»¶åœ°å€": "å£«æ—å€111å°ç£è‡ºåŒ—å¸‚å£«æ—å€ä¸­å±±åŒ—è·¯ä¸ƒæ®µ148-1è™Ÿ", "ç«‹æ¡ˆæ—¥æœŸ": "20251130", "ç«‹æ¡ˆæ™‚é–“": "232001"},
            {"æ¡ˆä»¶ç·¨è™Ÿ": "2025113010467", "æ´¾å·¥é …ç›®": "å¤§å‹å»¢æ£„ç‰©æ¸…é‹è¯ç¹«", "æ¡ˆä»¶åœ°å€": "æ¾å±±å€è‡ºåŒ—å¸‚æ¾å±±å€æ°‘æœ‰é‡Œ026é„°æ°‘æ¬Šæ±è·¯ä¸‰æ®µï¼‘ï¼ï¼–å··ï¼‘è™ŸäºŒæ¨“", "ç«‹æ¡ˆæ—¥æœŸ": "20251130", "ç«‹æ¡ˆæ™‚é–“": "231746"},
            {"æ¡ˆä»¶ç·¨è™Ÿ": "2025113010466", "æ´¾å·¥é …ç›®": "æ±¡æŸ“èˆ‰ç™¼", "æ¡ˆä»¶åœ°å€": "ä¸­å±±å€è‡ºåŒ—å¸‚ä¸­å±±å€å¤§ç›´é‡Œ018é„°åŒ—å®‰è·¯ï¼–ï¼‘ï¼•è™Ÿ", "ç«‹æ¡ˆæ—¥æœŸ": "20251130", "ç«‹æ¡ˆæ™‚é–“": "231125"},
            {"æ¡ˆä»¶ç·¨è™Ÿ": "2025113010465", "æ´¾å·¥é …ç›®": "è·¯ç‡ˆä¸äº®æˆ–æå£", "æ¡ˆä»¶åœ°å€": "å—æ¸¯å€115å°ç£è‡ºåŒ—å¸‚å—æ¸¯å€å—æ¹–å¤§æ©‹8è™Ÿ", "ç«‹æ¡ˆæ—¥æœŸ": "20251130", "ç«‹æ¡ˆæ™‚é–“": "230552"},
            {"æ¡ˆä»¶ç·¨è™Ÿ": "2025113010464", "æ´¾å·¥é …ç›®": "å¤§å‹å»¢æ£„ç‰©æ¸…é‹è¯ç¹«", "æ¡ˆä»¶åœ°å€": "ä¸­æ­£å€è‡ºåŒ—å¸‚ä¸­æ­£å€æ°¸æ˜Œé‡Œ002é„°æ±€å·è·¯ä¸€æ®µï¼’ï¼ï¼–å··ï¼“è™Ÿå››æ¨“", "ç«‹æ¡ˆæ—¥æœŸ": "20251130", "ç«‹æ¡ˆæ™‚é–“": "225630"},
            {"æ¡ˆä»¶ç·¨è™Ÿ": "2025113010463", "æ´¾å·¥é …ç›®": "é“è·¯æ•£è½ç‰©æˆ–æ²¹æ¼¬è™•ç†", "æ¡ˆä»¶åœ°å€": "ä¸­å±±å€é€šåŒ—è¡—-åŒ—å®‰è·¯", "ç«‹æ¡ˆæ—¥æœŸ": "20251130", "ç«‹æ¡ˆæ™‚é–“": "225623"},
            {"æ¡ˆä»¶ç·¨è™Ÿ": "2025113010462", "æ´¾å·¥é …ç›®": "å¤§å‹å»¢æ£„ç‰©æ¸…é‹è¯ç¹«", "æ¡ˆä»¶åœ°å€": "å¤§å®‰å€è‡ºåŒ—å¸‚å¤§å®‰å€é¾å®‰é‡Œ009é„°é’ç”°è¡—ï¼—å··ï¼”è™Ÿä¸‰æ¨“", "ç«‹æ¡ˆæ—¥æœŸ": "20251130", "ç«‹æ¡ˆæ™‚é–“": "225247"},
            {"æ¡ˆä»¶ç·¨è™Ÿ": "2025113010461", "æ´¾å·¥é …ç›®": "è·¯ç‡ˆä¸äº®æˆ–æå£", "æ¡ˆä»¶åœ°å€": "å£«æ—å€è‡ºåŒ—å¸‚è‡ºåŒ—å¸‚å£«æ—å€å¾Œæ¸¯é‡Œæ‰¿å¾·è·¯å››æ®µ318è™Ÿ", "ç«‹æ¡ˆæ—¥æœŸ": "20251130", "ç«‹æ¡ˆæ™‚é–“": "225036"},
            {"æ¡ˆä»¶ç·¨è™Ÿ": "2025113010460", "æ´¾å·¥é …ç›®": "å ´æ‰€èˆ‡è¨­æ–½å™ªéŸ³èˆ‰ç™¼", "æ¡ˆä»¶åœ°å€": "ä¸­å±±å€æ˜æ°´è·¯-æ˜æ°´è·¯439å··", "ç«‹æ¡ˆæ—¥æœŸ": "20251130", "ç«‹æ¡ˆæ™‚é–“": "224648"},
            {"æ¡ˆä»¶ç·¨è™Ÿ": "2025113010459", "æ´¾å·¥é …ç›®": "å¤§å‹å»¢æ£„ç‰©æ¸…é‹è¯ç¹«", "æ¡ˆä»¶åœ°å€": "ä¸­å±±å€è‡ºåŒ—å¸‚ä¸­å±±å€æ±Ÿå±±é‡Œ003é„°åˆæ±Ÿè¡—ï¼‘ï¼‘ï¼–å··ï¼‘ï¼™è™Ÿå››æ¨“", "ç«‹æ¡ˆæ—¥æœŸ": "20251130", "ç«‹æ¡ˆæ™‚é–“": "224437"},
            {"æ¡ˆä»¶ç·¨è™Ÿ": "2025113010458", "æ´¾å·¥é …ç›®": "å¤§å‹å»¢æ£„ç‰©æ¸…é‹è¯ç¹«", "æ¡ˆä»¶åœ°å€": "å…§æ¹–å€è‡ºåŒ—å¸‚å…§æ¹–å€å®‰æ¹–é‡Œ005é„°æ±æ¹–è·¯ï¼”ï¼“å··ï¼‘è™Ÿ6æ¨“", "ç«‹æ¡ˆæ—¥æœŸ": "20251130", "ç«‹æ¡ˆæ™‚é–“": "223941"},
            {"æ¡ˆä»¶ç·¨è™Ÿ": "2025113010457", "æ´¾å·¥é …ç›®": "å ´æ‰€èˆ‡è¨­æ–½å™ªéŸ³èˆ‰ç™¼", "æ¡ˆä»¶åœ°å€": "å…§æ¹–å€é‡‘æ¹–è·¯363å··", "ç«‹æ¡ˆæ—¥æœŸ": "20251130", "ç«‹æ¡ˆæ™‚é–“": "222806"}
        ];

        // è¡Œæ”¿å€åˆ—è¡¨ï¼šä¾ç…§ä»£ç¢¼ç”±å°è‡³å¤§æ’åº
        // ä»£ç¢¼ï¼š1:æ¾å±±, 2:å¤§å®‰, 3:ä¸­æ­£, 5:è¬è¯, 9:å¤§åŒ, 10:ä¸­å±±, 11:æ–‡å±±, 13:å—æ¸¯, 14:å…§æ¹–, 15:å£«æ—, 16:åŒ—æŠ•, 17:ä¿¡ç¾©
        const districts = ["æ¾å±±å€", "å¤§å®‰å€", "ä¸­æ­£å€", "è¬è¯å€", "å¤§åŒå€", "ä¸­å±±å€", "æ–‡å±±å€", "å—æ¸¯å€", "å…§æ¹–å€", "å£«æ—å€", "åŒ—æŠ•å€", "ä¿¡ç¾©å€"];
        
        const categoryMap = {
            cat1: { name: "å»¢æ£„ç‰©è™•ç†", keywords: ["å¤§å‹å»¢æ£„ç‰©æ¸…é‹è¯ç¹«", "é„°é‡Œç„¡ä¸»åƒåœ¾æ¸…é‹"] },
            cat2: { name: "ç’°å¢ƒå…¬å®³", keywords: ["å ´æ‰€èˆ‡è¨­æ–½å™ªéŸ³èˆ‰ç™¼", "æ±¡æŸ“èˆ‰ç™¼"] },
            cat3: { name: "é“è·¯èˆ‡è·¯ç‡ˆç¶­è­·", keywords: ["è·¯ç‡ˆä¸äº®æˆ–æå£", "è·¯ç‡ˆæ•…éšœæˆ–è¨­æ–½æå£", "é“è·¯æ•£è½ç‰©æˆ–æ²¹æ¼¬è™•ç†"] },
            cat4: { name: "äº¤é€šè¨­æ–½", keywords: ["äº¤é€šè™ŸèªŒç•°å¸¸", "äº¤é€šæ¨™èªŒåŠè¨­æ–½ç‰©æå£", "äº¤é€šæ¨™èªŒåŠè¨­æ–½ç‰©æ±™æ"] },
            cat5: { name: "å‹•ç‰©ç›¸é—œ", keywords: ["å‹•ç‰©æ•‘æ´", "å‹•ç‰©è™å¾…å‚·å®³"] },
            cat6: { name: "æ°´åˆ©è¨­æ–½èˆ‡ä¾›æ°´", keywords: ["ç”¨æˆ¶ç„¡æ°´", "æ¼æ°´å ±ä¿®", "é›¨æ°´ä¸‹æ°´é“å´æºæ¸…æ·¤"] },
            cat7: { name: "å…¬å…±è¨­æ–½ç¶œåˆç¶­è­·", keywords: ["è·¯æ¨¹è™•ç†", "æ©‹æ¨‘ç©æ·¹æ°´", "éš§é“ç©æ·¹æ°´"] }
        };

        let charts = { district: null, category: null, groups: null };
        let allSampleData = []; 
        let currentOffset = 0;
        let totalDBCount = 0; 
        const FETCH_LIMIT = 1000;

        function initCheckboxes() {
            const dContainer = document.getElementById('district-checks');
            dContainer.innerHTML = districts.map(d => `
                <label class="checkbox-card" id="card-dist-${d}">
                    <input type="checkbox" name="dist" value="${d}" onchange="updateCardStyle(this)">
                    <span class="text-xs font-medium">${d}</span>
                </label>
            `).join('');
            const cContainer = document.getElementById('category-checks');
            cContainer.innerHTML = Object.entries(categoryMap).map(([id, cat]) => `
                <label class="checkbox-card" id="card-cat-${id}">
                    <input type="checkbox" name="cat" value="${id}" onchange="updateCardStyle(this)">
                    <span class="text-xs font-medium">${cat.name}</span>
                </label>
            `).join('');
        }

        function updateCardStyle(cb) { cb.parentElement.classList.toggle('active', cb.checked); }

        function toggleAllCheckboxes(name) {
            const cbs = document.querySelectorAll(`input[name="${name}"]`);
            const allChecked = Array.from(cbs).every(cb => cb.checked);
            cbs.forEach(cb => { cb.checked = !allChecked; updateCardStyle(cb); });
        }

        function getDistrictFromAddress(address) {
            if (!address) return 'æœªçŸ¥';
            const match = address.match(/(.{2}å€)/);
            return match ? match[1] : 'å…¶ä»–';
        }

        function cleanAddressForMap(addr) {
            if (!addr) return "";
            
            // 1. å…ˆå°‡å…¨å½¢æ•¸å­—è½‰ç‚ºåŠå½¢ï¼Œæ–¹ä¾¿å¾ŒçºŒæ­£è¦è¡¨ç¤ºå¼åŒ¹é…
            let clean = addr.replace(/[ï¼-ï¼™]/g, (s) => String.fromCharCode(s.charCodeAt(0) - 0xfee0));
            
            // 2. å®šç¾©è¦å‰”é™¤çš„æ¨¡å¼ï¼šåŒ…å« é‡Œã€é„°ã€æ¨“å±¤è³‡è¨Š
            const removePatterns = [
                /\S+é‡Œ/g,                         // å‰”é™¤ã€ŒXXé‡Œã€(ä¾‹å¦‚ï¼šç¾©ä¿¡é‡Œ)
                /\d+é„°/g,                         // å‰”é™¤ã€ŒXXé„°ã€(ä¾‹å¦‚ï¼š009é„°)
                /\d+[Ff]/g,                       // å‰”é™¤ã€Œ5Fã€
                /\d+æ¨“(ä¹‹\d+)?/g,                  // å‰”é™¤ã€Œ5æ¨“ã€ã€ã€Œ5æ¨“ä¹‹1ã€
                /[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+æ¨“/g,       // å‰”é™¤ä¸­æ–‡æ¨“å±¤ã€Œäº”æ¨“ã€
                /åœ°ä¸‹\d+å±¤/g,                      // å‰”é™¤ã€Œåœ°ä¸‹1å±¤ã€
                /[Bb]\d+/g                        // å‰”é™¤ã€ŒB1ã€
            ];
        
            // 3. åŸ·è¡Œå‰”é™¤
            removePatterns.forEach(pattern => {
                clean = clean.replace(pattern, "");
            });
        
            // 4. æ¸…é™¤å‰å¾Œç©ºæ ¼åŠæœ«å°¾å¤šé¤˜æ¨™é»ï¼Œä¸¦å›å‚³
            return clean.replace(/[ ,ï¼Œã€]+$/, "").trim();
        }

        function jumpToLocation(address) {
            if (!address) return;
            const iframe = document.getElementById('main-map');
            const cleanedAddress = cleanAddressForMap(address);
            const searchUrl = `https://maps.google.com/maps?q=$${encodeURIComponent(cleanedAddress)}&output=embed&t=m&z=17`;
            iframe.src = searchUrl;
            document.querySelector('.map-wrapper').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function restoreOverviewMap() {
            document.getElementById('main-map').src = OVERVIEW_MAP_URL;
        }

        function switchPieTab(tab) {
            const containerItems = document.getElementById('container-items');
            const containerGroups = document.getElementById('container-groups');
            const tabItems = document.getElementById('tab-items');
            const tabGroups = document.getElementById('tab-groups');
            if (tab === 'items') {
                containerItems.classList.remove('hidden'); containerGroups.classList.add('hidden');
                tabItems.classList.add('tab-active'); tabGroups.classList.remove('tab-active');
            } else {
                containerItems.classList.add('hidden'); containerGroups.classList.remove('hidden');
                tabItems.classList.remove('tab-active'); tabGroups.classList.add('tab-active');
            }
        }

        async function fetchWithRetry(url, retries = 5) {
            let delay = 2000;
            const proxyNodes = [
                (u) => `https://api.allorigins.win/get?url=${encodeURIComponent(u)}`,
                (u) => `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,
                (u) => `https://corsproxy.io/?${encodeURIComponent(u)}`
            ];
            for (let i = 0; i < retries; i++) {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000);
                try {
                    const cacheBuster = `_t=${Date.now()}_r=${Math.random().toString(36).substring(7)}`;
                    const targetUrl = `${url}${url.includes('?') ? '&' : '?'}${cacheBuster}`;
                    const proxyUrl = proxyNodes[i % proxyNodes.length](targetUrl);
                    const response = await fetch(proxyUrl, { method: 'GET', signal: controller.signal });
                    clearTimeout(timeoutId);
                    if (response.status >= 500) throw new Error();
                    const responseText = await response.text();
                    if (!responseText || responseText.trim().toLowerCase().startsWith('<!doctype') || responseText.trim().startsWith('<html')) throw new Error();
                    const json = JSON.parse(responseText);
                    const data = json.contents ? (typeof json.contents === 'string' ? JSON.parse(json.contents) : json.contents) : json;
                    if (data && data.result) return data.result;
                } catch (e) {
                    clearTimeout(timeoutId);
                    if (i === retries - 1) throw e;
                    await new Promise(res => setTimeout(res, delay));
                    delay *= 1.5;
                }
            }
            return null;
        }

        async function initDashboard() {
            showLoading(true);
            updateStatus('æ­£åœ¨åŒæ­¥åˆå§‹åŒ–æ¨£æœ¬...', 'bg-slate-200', 'text-slate-600');
            try {
                const result = await fetchWithRetry(`${API_BASE_URL}&limit=${FETCH_LIMIT}`);
                if (result && result.results) {
                    allSampleData = result.results;
                    currentOffset = FETCH_LIMIT;

                    if (result.count !== undefined) {
                        totalDBCount = result.count;
                        document.getElementById('db-total-count').innerText = totalDBCount.toLocaleString();
                    }

                    updateDashboardUI(allSampleData);
                    updateStatus('â— å¯¦æ™‚æ•¸æ“šå·²åŒæ­¥', 'bg-emerald-100', 'text-emerald-700');
                } else { throw new Error(); }
            } catch (err) {
                allSampleData = fallbackSampleData;
                updateDashboardUI(allSampleData);
                updateStatus('â— æ¨£æœ¬å±•ç¤ºæ¨¡å¼', 'bg-amber-100', 'text-amber-700');
            } finally {
                setTimeout(() => showLoading(false), 500);
            }
        }

        function resetFilters() {
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => { cb.checked = false; updateCardStyle(cb); });
            document.getElementById('searchInput').value = "";
            document.getElementById('data-table-body').innerHTML = "";
            document.getElementById('table-placeholder').classList.remove('hidden');
            restoreOverviewMap();
            searchData();
        }

        async function searchData() {
            const keyword = document.getElementById('searchInput').value.trim().toLowerCase();
            const selectedDists = Array.from(document.querySelectorAll('input[name="dist"]:checked')).map(cb => cb.value);
            const selectedCats = Array.from(document.querySelectorAll('input[name="cat"]:checked')).map(cb => cb.value);
            
            document.getElementById('table-placeholder').classList.add('hidden');
            document.getElementById('loading-table').classList.remove('hidden');

            const filtered = allSampleData.filter(item => {
                const d = getDistrictFromAddress(item['æ¡ˆä»¶åœ°å€']);
                const p = (item['æ´¾å·¥é …ç›®'] || '').toLowerCase();
                const a = (item['æ¡ˆä»¶åœ°å€'] || '').toLowerCase();
                const id = (item['æ¡ˆä»¶ç·¨è™Ÿ'] || '').toLowerCase();
                const dMatch = selectedDists.length === 0 || selectedDists.includes(d);
                let cMatch = selectedCats.length === 0;
                if (!cMatch) cMatch = selectedCats.some(catId => categoryMap[catId].keywords.some(kw => p.includes(kw.toLowerCase())));
                const kMatch = !keyword || (p.includes(keyword) || a.includes(keyword) || id.includes(keyword));
                return dMatch && cMatch && kMatch;
            });

            updateDashboardUI(filtered);
            renderTable(filtered);
            document.getElementById('loading-table').classList.add('hidden');
            document.getElementById('load-more-container').classList.toggle('hidden', allSampleData.length < 100 || allSampleData === fallbackSampleData);
            document.getElementById('search-hint').innerText = `åˆ†æå®Œæˆï¼šç¬¦åˆé … ${filtered.length} / æ¨£æœ¬æ•¸ ${allSampleData.length}`;
            lucide.createIcons();
        }

        async function loadMore() {
            const btn = document.getElementById('loadMoreBtn');
            const spinner = document.getElementById('load-more-spinner');
            btn.classList.add('hidden'); spinner.classList.remove('hidden'); spinner.classList.add('flex');
            try {
                const result = await fetchWithRetry(`${API_BASE_URL}&limit=${FETCH_LIMIT}&offset=${currentOffset}`);
                if (result && result.results) {
                    allSampleData = [...allSampleData, ...result.results];
                    currentOffset += FETCH_LIMIT;
                    searchData();
                }
            } catch (e) { console.error(e); } finally {
                spinner.classList.add('hidden'); spinner.classList.remove('flex'); btn.classList.remove('hidden');
            }
        }

        function updateDashboardUI(data) {
            const districtsCounts = {};
            const itemsCounts = {};
            const groupsCounts = { cat1: 0, cat2: 0, cat3: 0, cat4: 0, cat5: 0, cat6: 0, cat7: 0, other: 0 };

            data.forEach(i => {
                const d = getDistrictFromAddress(i['æ¡ˆä»¶åœ°å€']);
                const p = i['æ´¾å·¥é …ç›®'] || 'å…¶ä»–';
                districtsCounts[d] = (districtsCounts[d] || 0) + 1;
                itemsCounts[p] = (itemsCounts[p] || 0) + 1;
                let matched = false;
                for (let k in categoryMap) {
                    if (categoryMap[k].keywords.some(kw => p.includes(kw))) {
                        groupsCounts[k]++; matched = true; break;
                    }
                }
                if (!matched) groupsCounts.other++;
            });

            const sortedDist = Object.entries(districtsCounts).sort((a,b) => b[1]-a[1]);
            const sortedItem = Object.entries(itemsCounts).sort((a,b) => b[1]-a[1]);

            document.getElementById('total-count').innerText = `${data.length.toLocaleString()} / ${allSampleData.length.toLocaleString()}`;
            document.getElementById('top-district').innerText = sortedDist[0] ? sortedDist[0][0] : '--';
            document.getElementById('top-category').innerText = sortedItem[0] ? sortedItem[0][0] : '--';

            renderCharts(districtsCounts, itemsCounts, groupsCounts);
        }

        function renderCharts(dCounts, iCounts, gCounts) {
            const dCtx = document.getElementById('districtChart').getContext('2d');
            if (charts.district) charts.district.destroy();
            charts.district = new Chart(dCtx, {
                type: 'bar',
                data: { labels: districts, datasets: [{ label: 'æ¡ˆä»¶é‡', data: districts.map(l => dCounts[l] || 0), backgroundColor: '#3b82f6', borderRadius: 4 }] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    onClick: (evt, elements) => {
                        if (elements.length > 0) {
                            const label = districts[elements[0].index];
                            const cb = document.querySelector(`input[name="dist"][value="${label}"]`);
                            cb.checked = !cb.checked; updateCardStyle(cb); searchData();
                        }
                    }
                }
            });

            const cCtx = document.getElementById('categoryChart').getContext('2d');
            if (charts.category) charts.category.destroy();
            const sI = Object.entries(iCounts).sort((a,b) => b[1]-a[1]).slice(0, 10);
            charts.category = new Chart(cCtx, {
                type: 'doughnut',
                data: { labels: sI.map(x=>x[0]), datasets: [{ data: sI.map(x=>x[1]), backgroundColor: ['#6366f1', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#64748b', '#0ea5e9', '#f43f5e'], borderWidth: 0 }] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { position: 'right', labels: { boxWidth: 10, usePointStyle: true } } },
                    cutout: '65%',
                    onClick: (evt, elements) => { if (elements.length > 0) { document.getElementById('searchInput').value = sI[elements[0].index][0]; searchData(); } }
                }
            });

            const gCtx = document.getElementById('groupPieChart').getContext('2d');
            if (charts.groups) charts.groups.destroy();
            const gLabels = Object.keys(categoryMap).map(k => categoryMap[k].name).concat(["å…¶ä»–"]);
            const gIds = Object.keys(categoryMap).concat(["other"]);
            charts.groups = new Chart(gCtx, {
                type: 'doughnut',
                data: { labels: gLabels, datasets: [{ data: gIds.map(id => gCounts[id]), backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#94a3b8'], borderWidth: 0 }] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { position: 'right', labels: { boxWidth: 10, usePointStyle: true } } },
                    cutout: '65%',
                    onClick: (evt, elements) => {
                        if (elements.length > 0 && gIds[elements[0].index] !== 'other') {
                            const cb = document.querySelector(`input[name="cat"][value="${gIds[elements[0].index]}"]`);
                            cb.checked = !cb.checked; updateCardStyle(cb); searchData();
                        }
                    }
                }
            });
        }

        function renderTable(data) {
            const tbody = document.getElementById('data-table-body');
            tbody.innerHTML = data.map(i => `
                <tr class="data-row hover:bg-blue-50/40 border-b border-slate-50 transition-all text-xs" onclick="jumpToLocation('${i['æ¡ˆä»¶åœ°å€']}')">
                    <td class="px-8 py-4 font-mono text-slate-400">${i['æ¡ˆä»¶ç·¨è™Ÿ'] || '-'}</td>
                    <td class="px-8 py-4 font-bold text-slate-800">${i['æ´¾å·¥é …ç›®'] || '-'}</td>
                    <td class="px-8 py-4 text-slate-500">
                        <span class="px-2 py-0.5 bg-blue-50 text-blue-600 rounded text-[10px] font-bold mr-2">${getDistrictFromAddress(i['æ¡ˆä»¶åœ°å€'])}</span>
                        ${i['æ¡ˆä»¶åœ°å€'] || '-'}
                    </td>
                    <td class="px-8 py-4 text-slate-400 font-mono">${(i['ç«‹æ¡ˆæ—¥æœŸ'] || '') + ' ' + (i['ç«‹æ¡ˆæ™‚é–“'] || '')}</td>
                </tr>
            `).join('');
        }

        function showLoading(s) { document.getElementById('loading').style.display = s ? 'flex' : 'none'; }
        function updateStatus(t, b, c) {
            const e = document.getElementById('data-status');
            e.className = `px-3 py-1 rounded-full text-xs font-bold ${b} ${c} transition-all`;
            e.innerText = t;
        }

        window.onload = () => {
            initCheckboxes();
            lucide.createIcons();
            initDashboard();
        };
    </script>
</body>

</html>




